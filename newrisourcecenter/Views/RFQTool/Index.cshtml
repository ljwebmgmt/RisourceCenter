@model IEnumerable<newrisourcecenter.Models.RFQViewModel>
@using Newtonsoft.Json
@{
    ViewBag.Title = "Index";
    Layout = "~/Views/Shared/_Layout.cshtml";
    string pages = Convert.ToString(Session["userPages"]);
    string[] userpages = { };
    if (pages != null)
    {
        userpages = pages.Split(',');
    }
}
<script>
    let gridApi = null;
    const rowData = @Html.Raw(JsonConvert.SerializeObject(Model));
    document.addEventListener('DOMContentLoaded', () => {
        const n1_name = '@(Context.Request.QueryString["n1_name"])';
        const n2_name = '@(Context.Request.QueryString["n2_name"])';
        const currentUserId = '@Session["userId"].ToString()';
        const editUrlBase = '@Url.Action("Edit")';
        const deleteUrlBase = '@Url.Action("Delete")';
        // 2. Define Columns with Filtering, Sorting, and Hiding
        const columnDefs = [
            { field: "ID", headerName: "ID", width: 90 },
            { field: "qte_num", headerName: "Quote Number", filter: true, sortable: true },
            {
                field: "end_user_name",
                headerName: 'End User',
                filter: true,
                cellRenderer: params => {
                    return params.value + '<br/>' + params.data.end_user_location;
                }
            },
            { field: "qte_ref", headerName: "Project Name", filter: true },
            {
                field: "mods_it",
                headerName: 'Variant Code',
                filter: true,
                cellRenderer: params => {
                    const partType = params.data.part_type_other;
                    var variantCode = '';
                    if (partType != null && partType != '') {
                        if (partType == "Climate Control" || partType == "Enclosure Spare Parts") {
                            variantCode = 'SP/CL';
                        }
                        else {
                            variantCode = partType;
                        }
                    }
                    else if (params.data.mods_it != null && params.data.mods_it != '') {
                        variantCode = 'V' + params.data.mods_it;
                    }
                    return variantCode;
                },
            },
            {
                field: "product_category",
                headerName: 'Product Category',
                filter: 'agTextColumnFilter'
            },
            {
                field: "submission_date", headerName: "Submission Date", filter: 'agDateColumnFilter',
                valueFormatter: params => {
                    if (!params.value) return "";
                    const date = new Date(params.value);
                    return date.toLocaleDateString();
                }
            },
            {
                field: "list_RFQ_logs", headerName: "Status", filter: 'agTextColumnFilter',
                cellRenderer: params => {
                    const logs = params.value;
                    const rowId = params.data.id;
                    if (!logs || logs.length === 0) {
                        return `<span id="status_${rowId}">-</span>`;
                    }
                    const lastLog = logs[logs.length - 1];
                    let displayValue = "";
                    if (lastLog.AdminfullName && lastLog.AdminfullName.trim() !== "") {
                        displayValue = `${lastLog.AdminfullName} - ${lastLog.Action}`;
                    } else {
                        displayValue = lastLog.Action;
                    }
                    return `<span id="status_${rowId}">${displayValue}</span>`;
                }
            },
            {
                field: "completion_date", headerName: "Completion Date", filter: 'agDateColumnFilter',
                valueFormatter: params => {
                    if (!params.value) return "";
                    const date = new Date(params.value);
                    return date.toLocaleDateString();
                }
            },
            { field: "updated_quote", headerName: "New Quote / Revision", filter: true, sortable: true },
            {
                headerName: "Admin Notes",
                field: "list_RFQ_logs",
                cellRenderer: params => {
                    const logs = params.value;
                    if (!logs || logs.length === 0) return '<span style="color:#999;">No Notes</span>';

                    return `<a href="#" onclick="processRFQs.showNotesModal('${params.data.ID}')">View Notes (${logs.length})</a>`;
                }
            },
            {
                headerName: "Actions",
                field: "ID",
                sortable: false,
                filter: false,
                pinned: 'right',
                width: 150,
                cellRenderer: params => {
                    const item = params.data;
                    const id = item.ID;
                    const logs = item.list_RFQ_logs || [];
                    const lastLog = logs.length > 0 ? logs[logs.length - 1] : null;

                    // Variables for cleaner logic
                    const isCloned = lastLog ? lastLog.IsCloned : false;
                    const lastAction = lastLog ? lastLog.Action : "";

                    let links = [];

                    // Helper to build URLs
                    const getUrl = (action, extraParams = "") =>
                        `${editUrlBase.replace("Edit", action)}?id=${id}&n1_name=${n1_name}&n2_name=${n2_name}${extraParams}`;

                    // --- Logic Branch 1: Completed or Admin Saved (Not Cloned) ---
                    if (logs.length > 0 && !isCloned && (lastAction === "Completed" || lastAction === "Admin Saved with Notes")) {
                        links.push(`<a href="${getUrl("Edit", "&ext_form=no&view=yes")}">View</a>`);
                    }

                    // --- Logic Branch 2: Is Cloned ---
                    else if (logs.length > 0 && isCloned) {
                        links.push(`<a href="${getUrl("Edit", "&ext_form=no&view=yes")}">View</a>`);

                        if (lastAction !== "Cloned/Not Submitted" && lastAction !== "Completed") {
                            links.push(`<a href="${getUrl("Edit", "&ext_form=no")}">Edit</a>`);
                        }
                    }

                    // --- Logic Branch 3: Default (Everything Else) ---
                    else {
                        links.push(`<a href="${getUrl("Edit", "&ext_form=no")}">Edit</a>`);

                        // Only show delete if NOT assigned
                        if (logs.length > 0 && lastAction !== "Assigned") {
                            const deleteUrl = `${deleteUrlBase}?id=${id}&n1_name=${n1_name}&n2_name=${n2_name}`;
                            links.push(`<a href="${deleteUrl}" onclick="deletef(this.href); return false;" style="color:red;">Delete</a>`);
                        }
                    }

                    return `<div>${links.join(' | ')}</div>`;
                }
            }
        ];
        const gridOptions = {
            rowData: rowData,
            columnDefs: columnDefs,
            pagination: true,
            paginationPageSize: 20,
            onGridReady: (params) => {
                gridApi = params.api;
                params.api.sizeColumnsToFit();
                initColumnMenu();
            } ,
        };
        const gridDiv = document.querySelector('#rfqTableGrid');
        gridApi = agGrid.createGrid(gridDiv, gridOptions);

        function initColumnMenu() {
            const menu = document.getElementById('columnToggleMenu');
            if (!menu || !gridApi) return;

            const cols = gridApi.getColumns();
            menu.innerHTML = ''; // Clear once

            cols.forEach(col => {
                const def = col.getColDef();
                // Skip hidden internal columns or the Action column
                if (!def.headerName || def.headerName === "Actions") return;

                const li = document.createElement('li');
                li.style.padding = "5px 15px";
                li.innerHTML = `
                    <label style="cursor:pointer; font-weight:normal; display:flex; align-items:center; gap:8px; margin:0;">
                        <input type="checkbox" ${col.isVisible() ? 'checked' : ''}
                               onchange="toggleColumn('${def.field}', this)">
                        ${def.headerName}
                    </label>
                `;
                menu.appendChild(li);
            });
        }
    });
    var processRFQs = {
        init: {

        },
        showNotesModal: function (id) {
            // 1. Find the row data in our global rowData variable
            const row = rowData.find(r => r.ID == id || r.id == id);
            if (!row || !row.list_RFQ_logs) return;

            // 2. Clear previous content and set the ID label
            const modalBody = $('#notesModalBody');
            modalBody.empty();
            $('#modalIdLabel').text(id);

            // 3. Loop through logs and build rows
            row.list_RFQ_logs.forEach(log => {
                const rowHtml = `
                    <tr>
                        <td>${log.fullName || log.AdminfullName || ''}</td>
                        <td style="font-weight:bold;">${log.Action || ''}</td>
                        <td>${log.Action_Time ? new Date(log.Action_Time).toLocaleString() : ''}</td>
                        <td><i style="color:#555;">${log.Notes || 'No notes provided'}</i></td>
                    </tr>
                `;
                modalBody.append(rowHtml);
            });

            // 4. Open the Bootstrap modal
            $('#notesModal').modal('show');
        }
    }
    jQuery(document).ready(processRFQs.init);

    function toggleColumn(field, checkbox) {
        if (gridApi) {
            gridApi.applyColumnState({
                state: [
                    {
                        colId: field,
                        hide: !checkbox.checked // In AG Grid, 'hide' is the property name
                    }
                ]
            });
        }
    }

    $(document).on('click', '#columnToggleMenu', function (e) {
        e.stopPropagation(); // Prevents Bootstrap from closing the menu on internal clicks
    });
</script>
<div class="main_content">
    @if (!string.IsNullOrEmpty(Request.QueryString["success"]))
    {
        <div class="alert alert-success">@Request.QueryString["success"]</div>
    }
    @if (ViewBag.readonlyView == "false")
    {
        <div style="display:inline-block;float:left;">
            @Html.ActionLink("Create RFQ >>", "Create", new { n1_name = @Request.QueryString["n1_name"], n2_name = @Request.QueryString["n2_name"], msg = "Create RFQ" }, htmlAttributes: new { @class = "btn btn-primary" })
        </div>
    }

    @*<div style="display:inline-block;width:70%;margin: 0px 0px 5px 20px;">
            <div style="display:inline-block;color:red;margin-right:100px;vertical-align:top;">New Features:  </div>
            <marquee behavior="scroll" loop="infinite" style="color:red;display:inline-block;width:60%;" scrolldelay="190">Click on the <font color="blue" size="2">Clone With Changes</font> button to modify old requests.<strong><font color="red" size="2"> RFQs older than December 2016 cannot be cloned.</font></strong></marquee>
        </div>*@
    <div style="display:inline-block;float:right;">
        @if (userpages.Contains("20121") || userpages.Contains("10122"))
        {
            @Html.ActionLink("RFQ Admin >>", "RfqAdmin", new { n1_name = @Request.QueryString["n1_name"], n2_name = @Request.QueryString["n2_name"], msg = "RFQ Admin" }, htmlAttributes: new { @class = "btn btn-primary" })
        }
    </div>
    <div style="display:inline-block; float:left; margin-left:20px;">
        <div class="dropdown">
            <button class="btn btn-default dropdown-toggle" type="button" data-toggle="dropdown">
                <img src="/images/manage.png" style="width:15px; margin-right:5px;" /> Hide/Show Columns
                <span class="caret"></span>
            </button>
            <ul class="dropdown-menu" id="columnToggleMenu" style="max-height: 400px; overflow-y: auto; padding: 10px 0;">
            </ul>
        </div>
    </div>
    <div class="table-wrapper" style="clear:both;margin-top:60px;">
        <div id="rfqTableGrid" class="ag-theme-quartz" style="height: 500px; width: 100%;"></div>
    </div>

</div>
<div class="modal fade" id="notesModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header" style="background-color: #E5E2AE;">
                <button type="button" class="close" data-dismiss="modal">&times;</button>
                <h4 class="modal-title">Admin Notes - ID: <span id="modalIdLabel"></span></h4>
            </div>
            <div class="modal-body" style="max-height: 450px; overflow-y: auto;">
                <table class="table table-striped table-bordered">
                    <thead>
                        <tr style="background:#f4f4f4;">
                            <th>Name</th>
                            <th>Action</th>
                            <th>Time</th>
                            <th>Notes</th>
                        </tr>
                    </thead>
                    <tbody id="notesModalBody">
                    </tbody>
                </table>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
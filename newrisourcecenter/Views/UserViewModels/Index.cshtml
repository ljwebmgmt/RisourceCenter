@model IEnumerable<newrisourcecenter.Models.UserViewModel>
@{
    ViewBag.Title = "Index";
    Layout = "~/Views/Shared/_Layout.cshtml";

    long siteRole = Convert.ToInt64(Session["siteRole"]);
    long adminRole = Convert.ToInt64(Session["userRole"]);
    long companyId = Convert.ToInt64(Session["companyId"]);
    long defaultCompId = companyId;
    if (!string.IsNullOrEmpty(Request.QueryString["compid"]))
    {
        defaultCompId = Convert.ToInt64(Request.QueryString["compid"]);
    }
}
<style type="text/css">
    .btn.btn-xs { padding: 1px 5px !important; height: auto !important; }
</style>
<script>
    let gridApi = null;
    const userDataSource = {
        getRows: (params) => {
            const compId = $('#compFilter').val() || 0;
            const locId = $('#locFilter').val() || 0;
            const search = $('#gridSearch').val() || "";

            // Send parameters to your new GetUsersPaged action
            const url = `/UserViewModels/GetUsersPaged?start=${params.startRow}&limit=20&compid=${compId}&locid=${locId}&querystring=${encodeURIComponent(search)}`;
            if (gridApi) {
                gridApi.setGridOption('loading', true);
            }
            fetch(url)
                .then(res => res.json())
                .then(data => {
                    gridApi.setGridOption('loading', false);
                    if (data.total === 0) {
                        gridApi.showNoRowsOverlay();
                    } else {
                        gridApi.hideOverlay();
                    }
                    params.successCallback(data.rows, data.total);
                })
                .catch(() => {
                    gridApi.setGridOption('loading', false);
                    params.failCallback();
                });
        }
    };
    document.addEventListener('DOMContentLoaded', () => {
        const canViewAccounts = @((User.IsInRole("Super Admin") || User.IsInRole("Local Admin") || User.IsInRole("Global Admin")).ToString().ToLower());
        const canDeleteUser = @((User.IsInRole("Super Admin") || User.IsInRole("Global Admin")).ToString().ToLower());
        const currentN1 = '@Request.QueryString["n1_name"]';
        const queryCompId = '@Request.QueryString["compid"]';
        const defaultCompId = '@companyId';
        // 2. Define Columns with Filtering, Sorting, and Hiding
        const columnDefs = [
            {
                headerName: "",
                field: "user_role",
                width: 50,
                sortable: false,
                filter: false,
                cellRenderer: params => {
                    // Replicates your Admin Star logic
                    if (params.value === "Admin") {
                        return '<span class="glyphicon glyphicon-star" style="color:red;"></span>';
                    }
                    return '';
                }
            },
            { headerName: "User ID", field: "usr_ID", width: 100 },
            { headerName: "First Name", field: "usr_fName", filter: 'agTextColumnFilter' },
            { headerName: "Last Name", field: "usr_lName", filter: 'agTextColumnFilter' },
            { headerName: "Email", field: "usr_email", filter: 'agTextColumnFilter', flex: 1 },
            {
                headerName: "Actions",
                width: 450, // Wider to accommodate multiple buttons
                sortable: false,
                filter: false,
                cellRenderer: params => {
                    if (!params.data) {
                        return '<span class="text-muted">Loading...</span>';
                    }
                    const item = params.data;
                    const fullName = `${item.usr_fName} ${item.usr_lName}`;
                    let html = '<div style="display: flex; gap: 5px; align-items: center; height: 100%;">';

                    // 1. Online Shop & SAP Accounts (Permission Based)
                    if (canViewAccounts) {
                        html += `
                            <a href="/Webshop/Index?n1_name=${currentN1}&n2_name=Online Shop Accounts&msg=${fullName}&user_ID=${item.usr_ID}&compid=${item.comp_ID}" class="btn btn-info btn-xs">Online Shop Accounts</a>
                            <a href="/partnerStockCheck/Index?n1_name=${currentN1}&n2_name=SAP Accounts&msg=${fullName}&user_ID=${item.usr_ID}&compid=${item.comp_ID}" class="btn btn-info btn-xs">SAP Accounts</a>
                        `;
                    }

                    // 2. Edit Button (Logic for CompID)
                    const activeCompId = queryCompId || defaultCompId;
                    html += `<a href="/UserViewModels/Edit?id=${item.usr_ID}&n1_name=${currentN1}&msg=${fullName}&compid=${activeCompId}&user_ID=${item.usr_ID}&n2_name=User Account" class="btn btn-success btn-xs">Edit</a>`;

                    // 3. Delete Button (Permission Based)
                    if (canDeleteUser) {
                        html += `<a href="/UserViewModels/Delete?id=${item.usr_ID}&n1_name=${currentN1}" class="btn btn-danger btn-xs btn-delete-user" id="delete">Delete</a>`;
                    }

                    html += '</div>';
                    return html;
                }
            }
        ];
        const gridOptions = {
            rowModelType: 'infinite',
            cacheBlockSize: 20,
            columnDefs: columnDefs,
            pagination: true,
            paginationPageSize: 20,
            onGridReady: (params) => {
                gridApi = params.api
                params.api.setGridOption('datasource', userDataSource);
                params.api.sizeColumnsToFit();
            },
            overlayLoadingTemplate: '<span class="ag-overlay-loading-center">Please wait while your users are loading...</span>',
            overlayNoRowsTemplate: '<span style="padding: 10px; border: 2px solid #444; background: lightgoldenrodyellow;">No users found for this filter.</span>'
        };
        const gridDiv = document.querySelector('#userTableGrid');
        gridApi = agGrid.createGrid(gridDiv, gridOptions);
        if (queryCompId > 0 || defaultCompId > 0) {
            loadLocations();
        }
    });

    function loadLocations() {
        const compId = $('#compFilter').val();
        const locDropdown = $('#locFilter');

        if (!compId || compId == "0") {
            locDropdown.empty().append('<option value="0">Select Location</option>').prop('disabled', true).selectpicker('refresh');
            onFilterChange();
            return;
        }

        // Call the JSON endpoint we created earlier
        fetch(`/UserViewModels/GetLocations?compid=${compId}`)
            .then(res => res.json())
            .then(data => {
                locDropdown.empty().append('<option value="0">All Locations</option>');
                data.forEach(loc => {
                    locDropdown.append(`<option value="${loc.id}">${loc.name}</option>`);
                });
                locDropdown.prop('disabled', false).selectpicker('refresh');
                onFilterChange();
            });
    }

    function onFilterChange() {
        // This tells the Infinite row model to purge its cache and start from page 1
        // it will automatically call your datasource.getRows()
        if (gridApi) {
            gridApi.setGridOption('datasource', userDataSource);
        }
    }

    function resetFilters() {
        $('#compFilter').val('0').selectpicker('refresh');
        $('#locFilter').val('0').prop('disabled', true).selectpicker('refresh');
        $('#gridSearch').val('');
        onFilterChange();
    }

    $(document).on('click', '.btn-delete-user', function (e) {
        e.preventDefault();

        if (!window.confirm('Are you sure you want to delete this user?')) {
            return false;
        }

        var obj = $(this);
        var originalText = obj.text();

        $.ajax({
            url: obj.attr('href'),
            type: 'DELETE',
            dataType: 'json',
            beforeSend: function () {
                gridApi.setGridOption('loading', true);
                obj.text('Loading....').prop('disabled', true);
            },
            success: function (res) {
                const messageContainer = $('.table-wrapper');

                if (res !== 'Ok') {
                    messageContainer.before('<div class="alert alert-danger">' + res + '</div>');
                }
                else {
                    messageContainer.before('<div class="alert alert-success">User successfully deleted</div>');
                    if (gridApi) {
                        gridApi.refreshInfiniteCache();
                    }
                }

                setTimeout(function () {
                    $('.alert').remove();
                }, 3000);
            },
            error: function () {
                alert("An error occurred while deleting the user.");
            },
            complete: function () {
                gridApi.hideOverlay();
                obj.text(originalText).prop('disabled', false);
            }
        });
        return false;
    });
</script>


<table>
    <tr>
        @if (User.IsInRole("Super Admin") || User.IsInRole("Local Admin") && User.IsInRole("Rittal User") || User.IsInRole("Global Admin"))
        {
        <td>
            <select id="compFilter" class="selectpicker select-dropdown" data-live-search="true" title="Filter By Companies" onchange="loadLocations()">
                <option value="0">All Companies</option>
                @foreach (var item in ViewBag.compData)
                {
                    if (string.IsNullOrEmpty(item.name))
                    {
                        continue;
                    }
                    <option value="@item.id" @(Convert.ToInt64(item.id.ToString()) == defaultCompId ? "selected" : "")>@item.name</option>
                }
            </select>
        </td>
        <td>
            <select id="locFilter" class="selectpicker select-dropdown" data-live-search="true" title="Filter By Locations" onchange="onFilterChange()" disabled>
                <option value="0">Select Location</option>
            </select>
        </td>
        <td>
            @Html.ActionLink("Add Users", "AddUser", "Account", new { n1_name = "Add Users" }, htmlAttributes: new { @class = "btn btn-primary" })
        </td>
        }
        <td>
            <form onsubmit="onFilterChange(); return false;">
                <span class="input-group stylish-input-group" style="width:300px;">
                    <input type="text" id="gridSearch" value="@Request.QueryString["querystring"]" placeholder="first or last names or email" class="form-control" />
                    <span class="input-group-addon" >
                        <button type="button" onclick="onFilterChange()">
                            <span class="glyphicon glyphicon-search"></span>
                        </button>
                    </span>
                </span>
            </form>
        </td>
        <td>
            <button type="button" class="btn btn-primary btn-reset" onclick="resetFilters()">Reset</button>
        </td>
    </tr>
</table>
<p class="glyphicon glyphicon-star" style="color:#E50043;font-size:14px;"> - Administrator</p>

<div class="table-wrapper" style="clear:both;">
    <div id="userTableGrid" class="ag-theme-quartz" style="height: 1000px; width: 100%;"></div>
</div>
@model IEnumerable<newrisourcecenter.Models.UserViewModel>
@{
    ViewBag.Title = "User Export";
    Layout = "~/Views/Shared/_Layout.cshtml";

    long siteRole = Convert.ToInt64(Session["siteRole"]);
    long adminRole = Convert.ToInt64(Session["userRole"]);
    long companyId = Convert.ToInt64(Session["companyId"]);
}
<script>
    let gridApi;

    const columnDefs = [
        {
            headerName: "",
            field: "user_role",
            width: 50,
            cellRenderer: params => params.value === "Admin" ?
                '<span class="glyphicon glyphicon-star" style="color:red;"></span>' : ''
        },
        { headerName: "User ID", field: "usr_ID", width: 100 },
        { headerName: "First Name", field: "usr_fName", flex: 1 },
        { headerName: "Last Name", field: "usr_lName", flex: 1 },
        { headerName: "Email", field: "usr_email", flex: 1.5 },
        {
            headerName: "Status",
            field: "inactive",
            cellRenderer: params => {
                if (!params.data) return '';
                return params.value ?
                    '<span class="label label-default">In-active</span>' :
                    '<span class="label label-success">Active</span>';
            }
        }
    ];

    const gridOptions = {
        columnDefs: columnDefs,
        rowModelType: 'infinite',
        cacheBlockSize: 20,
        pagination: true,
        paginationPageSize: 20,
        onGridReady: params => {
            gridApi = params.api;
            params.api.setGridOption('datasource', userDataSource);
        }
    };

    const userDataSource = {
        getRows: (params) => {
            gridApi.setGridOption('loading', true);

            // Find selected company ID from datalist
            const compName = $('#companySearch').val();
            const compId = $(`#companies option[value="${compName}"]`).attr('data-id') || 0;
            const locId = $('#locFilter').val() || 0;

            const url = `/UserViewModels/GetUsersPaged?start=${params.startRow}&limit=20&compid=${compId}&locid=${locId}`;

            fetch(url)
                .then(res => res.json())
                .then(data => {
                    gridApi.setGridOption('loading', false);
                    params.successCallback(data.rows, data.total);
                    if (data.total === 0) gridApi.showNoRowsOverlay();
                    else gridApi.hideOverlay();
                })
                .catch(() => {
                    gridApi.setGridOption('loading', false);
                    params.failCallback();
                });
        }
    };

    // Functions to handle UI interactions
    function onCompanyFilterChange() {
        const compName = $('#companySearch').val();
        const compId = $(`#companies option[value="${compName}"]`).attr('data-id');

        if (compId) {
            // Fetch locations for the selected company
            fetch(`/UserViewModels/GetLocations?compid=${compId}`)
                .then(res => res.json())
                .then(data => {
                    const locSelect = $('#locFilter');
                    locSelect.empty().append('<option value="0">All Locations</option>');
                    data.forEach(l => locSelect.append(`<option value="${l.id}">${l.name}</option>`));
                    $('#locContainer').show();
                    onFilterChange();
                });
        } else {
            $('#locContainer').hide();
            onFilterChange();
        }
    }

    function onFilterChange() {
        gridApi.refreshInfiniteCache();
    }

    function downloadCSV() {
        const compName = $('#companySearch').val();
        const compId = $(`#companies option[value="${compName}"]`).attr('data-id') || 0;
        window.location.href = `/UserViewModels/ExportCSV?compid=${compId}&locid=${$('#locFilter').val() || 0}`;
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
        const gridDiv = document.querySelector('#userTableGrid');
        gridApi = agGrid.createGrid(gridDiv, gridOptions);
    });
</script>
@if (User.IsInRole("Super Admin") || User.IsInRole("Local Admin") || User.IsInRole("Global Admin"))
{
    <div class="filter-header" style="margin-bottom: 15px; display: flex; gap: 10px; align-items: center;">
        <div style="display:flex; gap: 5px;">
            <input type="text" id="companySearch" class="form-control" placeholder="Search Company...." list="companies" style="width:300px;" />
            <datalist id="companies">
                @foreach (var item in ViewBag.compData)
                {
                    <option value="@item.name" data-id="@item.id">@item.name</option>
                }
            </datalist>
            <button class="btn btn-primary" onclick="onCompanyFilterChange()">Filter</button>
        </div>

        <div id="locContainer" style="display:none;">
            <select id="locFilter" class="form-control" onchange="onFilterChange()">
                <option value="0">All Locations</option>
            </select>
        </div>

        <button class="btn btn-primary" onclick="downloadCSV()">Download CSV</button>
    </div>
}

<p class="glyphicon glyphicon-star" style="color:#E50043;font-size:14px;"> - Administrator</p>

<div class="table-wrapper" style="clear:both;">
    <div id="userTableGrid" class="ag-theme-quartz" style="height: 1000px; width: 100%;"></div>
</div>
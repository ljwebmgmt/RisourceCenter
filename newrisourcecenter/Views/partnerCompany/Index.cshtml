@model IEnumerable<newrisourcecenter.Models.partnerCompanyViewModel>

@{
    ViewBag.Title = "Index";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
<style type="text/css">
    .btn.btn-xs {
        padding: 1px 5px !important;
        height: auto !important;
    }
</style>
<script>
    let gridApi;
    const adminUser = @((User.IsInRole("Super Admin") || User.IsInRole("Global Admin")).ToString().ToLower());
    const columnDefs = [
        { headerName: "Company Name", field: "comp_name", flex: 2, filter: true },
        { headerName: "MDF Program?", field: "comp_MDF", width: 100 },
        {
            headerName: "Total MDF Funds",
            field: "comp_MDF_amount",
            valueFormatter: p => p.value ? '$' + p.value.toLocaleString() : '$0',
            cellClass: 'text-right'
        },
        {
            headerName: "Funds For Training",
            field: "comp_MDF_tLimit",
            valueFormatter: p => p.value ? '$' + p.value.toLocaleString() : '$0',
            cellClass: 'text-right'
        },
        {
            headerName: "Funds For Promotional Activity",
            field: "comp_MDF_aLimit",
            valueFormatter: p => p.value ? '$' + p.value.toLocaleString() : '$0',
            cellClass: 'text-right'
        },
        {
            headerName: "Funds For Merchandise",
            field: "comp_MDF_mLimit",
            valueFormatter: p => p.value ? '$' + p.value.toLocaleString() : '$0',
            cellClass: 'text-right'
        },
        {
            headerName: "Total MKT Funds",
            field: "comp_MKT_Limit",
            valueFormatter: p => p.value ? '$' + p.value.toLocaleString() : '$0',
            cellClass: 'text-right'
        },
        {
            headerName: "Region",
            field: "comp_region",
            width: 120
        },
        {
            headerName: "Actions",
            width: 180,
            sortable: false,
            cellRenderer: params => {
                if (!params.data) {
                    return '<span class="text-muted">Loading...</span>';
                }
                const id = params.data.comp_ID
                let html = `<a href="/partnerCompany/Edit/${id}" class="btn btn-xs btn-info">Edit</a> `;
                if (adminUser) {
                    html += `<a href="/partnerCompany/Delete/${id}" class="btn btn-xs btn-danger delete-company">Delete</a>`;
                }
                return html;
            }
        }
    ];

    const gridOptions = {
        columnDefs: columnDefs,
        rowModelType: 'infinite',
        pagination: true,
        paginationPageSize: 20,
        cacheBlockSize: 20,
        onGridReady: params => {
            gridApi = params.api;
            params.api.setGridOption('datasource', companyDataSource);
        }
    };

    const companyDataSource = {
        getRows: (params) => {
            gridApi.setGridOption('loading', true);
            const searchText = $('#companySearchInput').val();

            fetch(`/partnerCompany/GetCompaniesPaged?start=${params.startRow}&limit=20&search=${searchText}`)
                .then(res => res.json())
                .then(data => {
                    gridApi.setGridOption('loading', false);
                    params.successCallback(data.rows, data.total);
                })
                .catch(() => params.failCallback());
        }
    };

    function onSearchChange() {
        gridApi.refreshInfiniteCache();
    }

    // Handle Enter Key in Search
    $('#companySearchInput').on('keypress', function (e) {
        if (e.which === 13) onSearchChange();
    });

    document.addEventListener('DOMContentLoaded', () => {
        const gridDiv = document.querySelector('#companyGrid');
        gridApi = agGrid.createGrid(gridDiv, gridOptions);
    });

    $(document).on('click', '.delete-company', function (e) {
        e.preventDefault();
        if (!window.confirm('Are you sure you want to delete this company?')) {
            return false;
        }
        var obj = $(this);
        var originalText = obj.text();
        $.ajax({
            url: obj.attr('href'),
            type: 'DELETE',
            dataType: 'json',
            beforeSend: function () {
                gridApi.setGridOption('loading', true);
                obj.text('Loading....').prop('disabled', true);
            },
            success: function (res) {
                const messageContainer = $('.table-wrapper');

                if (res !== 'Ok') {
                    messageContainer.before('<div class="alert alert-danger">' + res + '</div>');
                }
                else {
                    messageContainer.before('<div class="alert alert-success">Company successfully deleted</div>');
                    if (gridApi) {
                        gridApi.refreshInfiniteCache();
                    }
                }

                setTimeout(function () {
                    $('.alert').remove();
                }, 3000);
            },
            error: function () {
                alert("An error occurred while deleting the user.");
            },
            complete: function () {
                gridApi.hideOverlay();
                obj.text(originalText).prop('disabled', false);
            }
        });
        return false;
    });
</script>
@if (User.IsInRole("Super Admin") || User.IsInRole("Local Admin") && User.IsInRole("Rittal User") || User.IsInRole("Global Admin"))
{
    <div class="header-container" style="display:flex; align-items: center; margin-bottom: 20px;">
        <div>
            @Html.ActionLink("Add Company", "Create", new { n1_name = Request.QueryString["n1_name"], msg = "Add Company" }, htmlAttributes: new { @class = "btn btn-primary" })
        </div>

        <div class="input-group" style="margin-left:20px;width:350px;">
            <input type="text" id="companySearchInput" class="form-control" placeholder="Search by ID or Company Name..." />
            <span class="input-group-btn">
                <button class="btn btn-default" type="button" onclick="onSearchChange()">
                    <span class="glyphicon glyphicon-search"></span>
                </button>
            </span>
        </div>
    </div>
}

<div class="table-wrapper" style="clear:both;">
    <div id="companyGrid" class="ag-theme-quartz" style="height: 1000px; width: 100%;"></div>
</div>